{% extends "base.html" %}

{% block title %}Design Color Variant Generator - Home{% endblock %}

{% block content %}
<div class="hero-section">
    <div class="hero-content">
        <h1 class="hero-title">Transform Your Designs with AI</h1>
        <p class="hero-subtitle">Upload your design image and instantly generate color variants. Change blue to red, beige to navy blue, and more!</p>
        <div class="hero-features">
            <div class="feature">
                <i class="fas fa-magic"></i>
                <span>AI-Powered Color Replacement</span>
            </div>
            <div class="feature">
                <i class="fas fa-download"></i>
                <span>Instant Download</span>
            </div>
            <div class="feature">
                <i class="fas fa-palette"></i>
                <span>Multiple Color Options</span>
            </div>
        </div>
    </div>
</div>

<div class="upload-section">
    <div class="container">
        <div class="upload-card">
            <div class="upload-header">
                <h2>Upload Your Design</h2>
                <p>Supported formats: PNG, JPG, JPEG, GIF, BMP, TIFF, WEBP, ICO - Any size supported!</p>
            </div>
            
            <form id="uploadForm" enctype="multipart/form-data" class="upload-form">
                <div class="file-upload-area" id="fileUploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">
                        <h3>Drag & Drop your image here</h3>
                        <p>or <span class="upload-link">browse files</span></p>
                    </div>
                    <input type="file" id="fileInput" name="file" accept="image/png,image/jpeg,image/jpg,image/gif,image/bmp,image/tiff,image/webp,image/x-icon,image/vnd.microsoft.icon" style="display: none;">
                </div>
                
                <div class="color-options">
                    <h3>Color Replacement Options</h3>
                    <div class="color-replacement-container">
                        <div class="color-replacement-item">
                            <div class="color-input-group">
                                <label class="color-label">From Color:</label>
                                <div class="color-input-wrapper">
                                    <input type="color" id="fromColor" name="from_color" value="#1a237e" class="color-input">
                                    <span class="color-preview" id="fromColorPreview" style="background-color: #1a237e;"></span>
                                    <input type="text" id="fromColorHex" name="from_color_hex" value="#1a237e" class="color-hex-input" placeholder="#1a237e">
                                </div>
                            </div>
                            <div class="arrow-icon">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                            <div class="color-input-group">
                                <label class="color-label">To Color:</label>
                                <div class="color-input-wrapper">
                                    <input type="color" id="toColor" name="to_color" value="#d32f2f" class="color-input">
                                    <span class="color-preview" id="toColorPreview" style="background-color: #d32f2f;"></span>
                                    <input type="text" id="toColorHex" name="to_color_hex" value="#d32f2f" class="color-hex-input" placeholder="#d32f2f">
                                </div>
                            </div>
                        </div>
                        
                        <div class="color-tolerance">
                            <label for="tolerance">Color Tolerance:</label>
                            <input type="range" id="tolerance" name="tolerance" min="10" max="100" value="30" class="tolerance-slider">
                            <span id="toleranceValue">30</span>
                        </div>
                        
                        <div class="output-settings">
                            <h4>Output Settings</h4>
                            <div class="settings-grid">
                                <div class="setting-group">
                                    <h5>Image Size</h5>
                                    <p class="setting-description">Enter dimensions in pixels. Leave empty for original size.</p>
                                    <div class="size-inputs">
                                        <div class="input-row">
                                            <label for="outputWidth">Width (pixels):</label>
                                            <input type="number" id="outputWidth" name="output_width" min="1" max="10000" placeholder="Auto" class="size-input">
                                        </div>
                                        <div class="input-row">
                                            <label for="outputHeight">Height (pixels):</label>
                                            <input type="number" id="outputHeight" name="output_height" min="1" max="10000" placeholder="Auto" class="size-input">
                                        </div>
                                        <div class="checkbox-row">
                                            <label class="checkbox-label">
                                                <input type="checkbox" id="maintainAspectRatio" checked>
                                                <span class="checkmark"></span>
                                                Maintain aspect ratio (uncheck for exact dimensions)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <h5>Image Quality</h5>
                                    <div class="quality-inputs">
                                        <div class="input-row">
                                            <label for="imageQuality">Quality (1-100):</label>
                                            <input type="range" id="imageQuality" name="image_quality" min="1" max="100" value="95" class="quality-slider">
                                            <span id="qualityValue">95</span>
                                        </div>
                                        <div class="input-row">
                                            <label for="imageFormat">Output Format:</label>
                                            <select id="imageFormat" name="image_format" class="format-select">
                                                <option value="png">PNG (Lossless)</option>
                                                <option value="jpg">JPEG (Compressed)</option>
                                                <option value="bmp">BMP (Uncompressed)</option>
                                                <option value="tiff">TIFF (High Quality)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="preset-buttons">
                            <button type="button" class="preset-btn" data-from="#1a237e" data-to="#d32f2f">Blue → Red</button>
                            <button type="button" class="preset-btn" data-from="#d4af37" data-to="#000080">Beige → Navy</button>
                            <button type="button" class="preset-btn" data-from="#000000" data-to="#ffffff">Black → White</button>
                            <button type="button" class="preset-btn" data-from="#ffffff" data-to="#000000">White → Black</button>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="process-btn" id="processBtn" disabled>
                    <i class="fas fa-magic"></i>
                    <span>Generate Color Variant</span>
                </button>
            </form>
        </div>
    </div>
</div>

<div class="result-section" id="resultSection" style="display: none;">
    <div class="container">
        <div class="result-card">
            <div class="result-header">
                <h2>Your Color Variant</h2>
                <button class="download-btn" id="downloadBtn">
                    <i class="fas fa-download"></i>
                    Download
                </button>
            </div>
            <div class="result-content">
                <div class="image-comparison">
                    <div class="image-container">
                        <h3>Original</h3>
                        <div class="image-wrapper">
                            <img id="originalImage" src="" alt="Original Image">
                        </div>
                    </div>
                    <div class="image-container">
                        <h3>Color Variant</h3>
                        <div class="image-wrapper">
                            <img id="processedImage" src="" alt="Processed Image">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="features-section">
    <div class="container">
        <h2 class="section-title">How It Works</h2>
        <div class="features-grid">
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-upload"></i>
                </div>
                <h3>1. Upload</h3>
                <p>Upload your design image in any supported format. Our AI will analyze the colors automatically.</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-cogs"></i>
                </div>
                <h3>2. Configure</h3>
                <p>Choose which colors to replace. Select from blue to red, beige to navy blue, or customize your own.</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-magic"></i>
                </div>
                <h3>3. Generate</h3>
                <p>Our advanced AI processes your image and creates a perfect color variant while preserving all details.</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-download"></i>
                </div>
                <h3>4. Download</h3>
                <p>Download your transformed design instantly. High-quality output ready for any use case.</p>
            </div>
        </div>
    </div>
</div>

<div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="loading-content">
        <div class="spinner"></div>
        <h3>Processing Your Image</h3>
        <p>Our AI is analyzing colors and creating your variant...</p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('fileInput');
    const fileUploadArea = document.getElementById('fileUploadArea');
    const uploadForm = document.getElementById('uploadForm');
    const processBtn = document.getElementById('processBtn');
    const resultSection = document.getElementById('resultSection');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const originalImage = document.getElementById('originalImage');
    const processedImage = document.getElementById('processedImage');
    const downloadBtn = document.getElementById('downloadBtn');
    
    let downloadUrl = '';

    // File upload handling
    fileUploadArea.addEventListener('click', () => fileInput.click());
    fileUploadArea.addEventListener('dragover', handleDragOver);
    fileUploadArea.addEventListener('dragleave', handleDragLeave);
    fileUploadArea.addEventListener('drop', handleDrop);
    fileInput.addEventListener('change', handleFileSelect);

    function handleDragOver(e) {
        e.preventDefault();
        fileUploadArea.classList.add('dragover');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
    }

    function handleDrop(e) {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect();
        }
    }

    function handleFileSelect() {
        const file = fileInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                originalImage.src = e.target.result;
                processBtn.disabled = false;
                fileUploadArea.classList.add('file-selected');
                
                // Calculate aspect ratio when image loads
                originalImage.onload = function() {
                    originalAspectRatio = this.naturalWidth / this.naturalHeight;
                    console.log('Original image dimensions:', this.naturalWidth, 'x', this.naturalHeight);
                    console.log('Aspect ratio:', originalAspectRatio);
                };
            };
            reader.readAsDataURL(file);
        }
    }

    // Color picker functionality
    const fromColorInput = document.getElementById('fromColor');
    const toColorInput = document.getElementById('toColor');
    const fromColorHex = document.getElementById('fromColorHex');
    const toColorHex = document.getElementById('toColorHex');
    const fromColorPreview = document.getElementById('fromColorPreview');
    const toColorPreview = document.getElementById('toColorPreview');
    const toleranceSlider = document.getElementById('tolerance');
    const toleranceValue = document.getElementById('toleranceValue');
    const presetButtons = document.querySelectorAll('.preset-btn');
    
    // Output settings elements
    const outputWidth = document.getElementById('outputWidth');
    const outputHeight = document.getElementById('outputHeight');
    const maintainAspectRatio = document.getElementById('maintainAspectRatio');
    const imageQuality = document.getElementById('imageQuality');
    const qualityValue = document.getElementById('qualityValue');
    const imageFormat = document.getElementById('imageFormat');

    // Sync color picker with hex input
    fromColorInput.addEventListener('input', function() {
        fromColorHex.value = this.value;
        fromColorPreview.style.backgroundColor = this.value;
    });

    toColorInput.addEventListener('input', function() {
        toColorHex.value = this.value;
        toColorPreview.style.backgroundColor = this.value;
    });

    // Sync hex input with color picker
    fromColorHex.addEventListener('input', function() {
        if (this.value.match(/^#[0-9A-F]{6}$/i)) {
            fromColorInput.value = this.value;
            fromColorPreview.style.backgroundColor = this.value;
        }
    });

    toColorHex.addEventListener('input', function() {
        if (this.value.match(/^#[0-9A-F]{6}$/i)) {
            toColorInput.value = this.value;
            toColorPreview.style.backgroundColor = this.value;
        }
    });

    // Tolerance slider
    toleranceSlider.addEventListener('input', function() {
        toleranceValue.textContent = this.value;
    });

    // Quality slider
    imageQuality.addEventListener('input', function() {
        qualityValue.textContent = this.value;
    });

    // Aspect ratio functionality
    let originalAspectRatio = 1;
    
    function updateAspectRatio() {
        if (maintainAspectRatio.checked && originalAspectRatio > 0) {
            if (outputWidth.value && !outputHeight.value) {
                outputHeight.value = Math.round(outputWidth.value / originalAspectRatio);
            } else if (outputHeight.value && !outputWidth.value) {
                outputWidth.value = Math.round(outputHeight.value * originalAspectRatio);
            }
        }
    }
    
    outputWidth.addEventListener('input', updateAspectRatio);
    outputHeight.addEventListener('input', updateAspectRatio);
    maintainAspectRatio.addEventListener('change', updateAspectRatio);

    // Preset buttons
    presetButtons.forEach(button => {
        button.addEventListener('click', function() {
            const fromColor = this.getAttribute('data-from');
            const toColor = this.getAttribute('data-to');
            
            fromColorInput.value = fromColor;
            fromColorHex.value = fromColor;
            fromColorPreview.style.backgroundColor = fromColor;
            
            toColorInput.value = toColor;
            toColorHex.value = toColor;
            toColorPreview.style.backgroundColor = toColor;
        });
    });

    // Form submission
    uploadForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(uploadForm);
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Please select a file first');
            return;
        }

        // Validate colors
        const fromColor = fromColorHex.value;
        const toColor = toColorHex.value;
        
        if (!fromColor.match(/^#[0-9A-F]{6}$/i) || !toColor.match(/^#[0-9A-F]{6}$/i)) {
            alert('Please enter valid hex colors (e.g., #ff0000)');
            return;
        }

        // Get and validate output settings
        const width = outputWidth.value ? parseInt(outputWidth.value) : null;
        const height = outputHeight.value ? parseInt(outputHeight.value) : null;
        const quality = parseInt(imageQuality.value);
        const format = imageFormat.value;
        
        // Validate dimensions
        if (width && (width < 1 || width > 10000)) {
            alert('Width must be between 1 and 10000 pixels');
            return;
        }
        if (height && (height < 1 || height > 10000)) {
            alert('Height must be between 1 and 10000 pixels');
            return;
        }
        
        // Add settings to form data
        formData.append('output_width', width || '');
        formData.append('output_height', height || '');
        formData.append('maintain_aspect_ratio', maintainAspectRatio.checked);
        formData.append('image_quality', quality);
        formData.append('image_format', format);

        loadingOverlay.style.display = 'flex';
        
        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            // Check if response is ok
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('Non-JSON response:', text);
                throw new Error('Server returned non-JSON response. Please try again.');
            }

            const result = await response.json();
            
            if (result.success) {
                processedImage.src = 'data:image/png;base64,' + result.image_data;
                downloadUrl = result.download_url;
                resultSection.style.display = 'block';
                resultSection.scrollIntoView({ behavior: 'smooth' });
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            console.error('Upload error:', error);
            alert('Error processing image: ' + error.message);
        } finally {
            loadingOverlay.style.display = 'none';
        }
    });

    // Download functionality
    downloadBtn.addEventListener('click', function() {
        if (downloadUrl) {
            window.open(downloadUrl, '_blank');
        }
    });
});
</script>
{% endblock %}
